/*
 build time: Sep 9th,2013 23:19
 author: jiejie.zhuo
 */
 (function(){window.onload=function(){function f(e){if("undefined"!=typeof k[e])return k[e];k[e]=new Image;k[e].src=l+e;return k[e]}function q(e,g){var r=0,d=e.length,f;for(f in e)k[e[f]]=new Image,k[e[f]].onload=function(){r++;r>=d&&g()},k[e[f]].src=l+e[f]}var l="images/",s=navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|mobile)/),d=document.getElementById("game-box"),i=d.width,h=d.height,g=d.getContext("2d"),t=function(){var e=$(window).width(),f=$(window).height();h=800>f?f:800;
i=480>e?e:480;$(d).attr({height:h,width:i}).offset({top:(f-h)/2});g.font="30px Microsoft YaHei";g.fillStyle="#333"};window.onresize=t;t();var k=[];q(["bg.jpg","loading1.png","loading2.png","loading3.png","logo.png"],function(){var e=0,k=setInterval(function(){var d=f("bg.jpg");g.drawImage(d,0,0,d.width,d.height);var d=f("logo.png"),h=d.width;g.drawImage(d,(i-h)/2,100,h,d.height);600==e&&(e=0);d=f("loading"+(parseInt(e/200)+1)+".png");h=d.width;g.drawImage(d,(i-h)/2,220,h,d.height);e++},1);q("cartridge.png cartridge_power.png die1.png die2.png me.png plain1.png plain2.png plain3.png plain2_hurt.png plain3_hurt.png plain1_die1.png plain1_die2.png plain1_die3.png plain2_die1.png plain2_die2.png plain2_die3.png plain2_die4.png plain3_die1.png plain3_die2.png plain3_die3.png plain3_die4.png plain3_die5.png plain3_die6.png me_die1.png me_die2.png me_die3.png me_die4.png prop1.png prop2.png bomb.png me_2.png plain3_2.png".split(" "),
function(){var e=function(a){this.type=a;this.hp;this.height;this.width;this.maxSpeed;this.dieTime;this.status=true;switch(a){case 1:this.hp=1;this.score=1E3;this.maxSpeed=5;this.dieTime=60;break;case 2:this.hp=8;this.score=8E3;this.maxSpeed=2;this.dieTime=80;break;case 3:this.hp=18;this.score=3E4;this.maxSpeed=1;this.dieTime=120}this.modelimg="plain"+this.type+".png";this.model=f(this.modelimg);if(this.type==3){this.modelimg2="plain3_2.png";this.model2=f(this.modelimg2)}this.width=i/480*this.model.width;
this.height=this.width/this.model.width*this.model.height;this.x=Math.random()*(i-this.width);this.y=-this.height;a=b.time/1E3>10?10:b.time/1E3;this.speed=Math.random()*(a-1)+1;this.speed=this.speed<0.5?Math.random()*0.5+0.5:this.speed;this.speed=this.speed>this.maxSpeed?this.maxSpeed:this.speed;this.show=function(){this.type==3?g.drawImage(b.time%30>15?this.model:this.model2,this.x,this.y,this.width,this.height):g.drawImage(this.model,this.x,this.y,this.width,this.height)};this.die=function(){var a=
this.type,j=this.x,c=this.y,d=this.width,e=this.height;b.plainsDies.push(new function(b){this.animationTime=b;this.call=function(){if(!(this.animationTime<=0)){var h=f("plain"+a+"_die"+(parseInt((b-this.animationTime)/20)+1)+".png");g.drawImage(h,j,c,d,e);this.animationTime--}}}(this.dieTime));b.score=b.score+this.score;this.status=false};var c=this.hp;this.byAttack=function(){this.hp--;if(this.hp<=0)this.die();else if(this.hp<=c/3)this.model=f("plain"+this.type+"_hurt.png")}},l={show:function(b){$("#content").html(b);
$("#modal").removeClass("hide")},hide:function(){$("#modal").addClass("hide")}},m=f("bg.jpg"),p=m.width,n=m.height;g.drawImage(m,0,0,p,n);var a={};a.x;a.y;a.lastX;a.lastY;a.bomb=0;a.status=true;a.model=f("me.png");a.model2=f("me_2.png");a.width=i/480*a.model.width;a.height=a.width/a.model.width*a.model.height;a.move=function(b,c){a.lastX=a.x;a.lastY=a.y;a.x=b-a.width/2;a.y=c-a.height/2;a.x=a.x>i-a.width?i-a.width:a.x;a.x=a.x<0?0:a.x;a.y=a.y>h-a.height?h-a.height:a.y;a.y=a.y<0?0:a.y};a.moveing=function(){if(a.status){g.drawImage(b.time%
30>15?a.model:a.model2,a.x,a.y,a.width,a.height);a.attacking()}};a.cartridges=[];a.cartridge=function(b,c){var d=f(a.attackPower?"cartridge_power.png":"cartridge.png");this.model=d;this.width=i/480*d.width;this.height=this.width/d.width*d.height;this.x=b+(a.width-this.width)/2;this.y=c-this.height};a.attackTime=0;a.attackPower=false;a.attack=function(){if(a.status){a.attackTime++;if(a.attackTime*b.refreshInterval%(b.refreshInterval*15)==0){a.attackTime=0;var j;j=a.attackPower?[new a.cartridge(a.x-
a.width/5,a.y),new a.cartridge(a.x+a.width/5,a.y)]:[new a.cartridge(a.x,a.y)];Array.prototype.push.apply(a.cartridges,j)}}};a.attacking=function(){a.attack();for(var j=a.cartridges.length;j--;){var c=a.cartridges[j];g.drawImage(c.model,c.x,c.y,c.width,c.height);if(c.y<=0)a.cartridges.splice(j,1);else{for(var d=b.plains.length;d--;){var e=b.plains[d],o=c.x,f=c.y,h=f-10;if(o>e.x&&o<e.x+e.width&&h<e.y+e.height+e.speed&&f>=e.y+e.height){e.byAttack();a.cartridges.splice(j,1)}}c.y=c.y-10}}};a.die=function(){function j(){var a=
4*c;this.animationTime=4*c;this.call=function(){this.animationTime==1&&b.over();var j=f("me_die"+(parseInt((a-this.animationTime)/c)+1)+".png");g.drawImage(j,d,e,h,o);this.animationTime--}}if(a.status){a.status=false;var c=20,d=this.x,e=this.y,o=this.height,h=this.width;b.plainsDies.push(new j)}};var b={score:0};b.me=a;b.time=0;b.refreshInterval=8;b.refresh=function(){b.time++;b.bgScroll();b.plainsScroll();b.plainsDying();b.me.moveing();b.propShow();b.refreshMessage()};b.bgScrollTime=0;b.bgScroll=
function(){b.bgScrollTime=b.bgScrollTime+0.5;if(b.bgScrollTime>n)b.bgScrollTime=0;g.drawImage(m,0,b.bgScrollTime-n,p,n);g.drawImage(m,0,b.bgScrollTime,p,n)};b.prop=function(a){this.type=a;this.status="show";this.isDeleted=false;this.modelImg;switch(a){case 1:this.modelImg="prop1.png";break;case 2:this.modelImg="prop2.png"}this.model=f(this.modelImg);this.width=i/480*this.model.width;this.height=this.model.height/this.model.width*this.width;this.x=Math.random()*(i-this.width);this.y=-this.height;var c=
this.speed=6,d=this.animateTime=70;this.showType="down";this.show=function(){if(this.animateTime<=d/2)this.showType="up";g.drawImage(this.model,this.x,this.y,this.width,this.height);if(e(this)){this.isDeleted=true;this.byGain()}else{var b=(h+this.height)/3/(d/2);this.speed=b;this.y=this.showType=="down"?this.y+b:this.y-b;this.animateTime--;if(this.animateTime<=0){this.speed=c;this.status="move"}}};this.move=function(){this.y=this.y+this.speed;g.drawImage(this.model,this.x,this.y,this.width,this.height);
if(e(this)){this.isDeleted=true;this.byGain()}};this.byGain=function(){switch(this.type){case 1:b.me.bomb++;break;case 2:b.me.attackPower=true;b.me.attackPowerClock=setTimeout(function(){b.me.attackPower=false},15E3)}};var e=function(a){var c=a.x;if(a.x+a.width<b.me.x||c>b.me.x+b.me.width)return false;c=a.y+(a.status=="move"?a.speed:a.showType=="down"?a.speed:-a.speed);return(a.y+a.height>b.me.y||c+a.height<b.me.y)&&b.me.lastY>a.y+a.height?false:true}};b.addProp=function(){b.time*b.refreshInterval%
25E3==0&&b.props.push(new b.prop(parseInt(Math.random()*1.8+1.1)))};b.props=[];b.propShow=function(){b.addProp();for(var a=b.props.length;a--;){var c=b.props[a];if(c.isDeleted==true)b.props.splice(a,1);else{c[c.status]();c.y>h&&b.props.splice(a,1)}}};b.useBomb=function(){if(!(b.me.bomb<=0)){b.me.bomb--;for(var a=b.plains.length;a--;)b.plains[a].die()}};b.plains=[];b.plainsNum=0;b.addPlain=function(){if(b.bgScrollTime%30==0){if(b.plainsNum==26)b.plainsNum=0;b.plainsNum++;switch(true){case b.plainsNum%
13==0:b.plains.push(new e(3));break;case b.plainsNum%6==0:b.plains.push(new e(2));break;default:b.plains.push(new e(1))}}};b.plainsScroll=function(){b.addPlain();for(var a=b.plains.length;a--;){var c=b.plains[a];if(c.y>h||c.status==false)b.plains.splice(a,1);else{c.show();var d;var e=[c.x,c.y];d=[c.x+c.width,c.y+c.height];var f=[b.me.x+b.me.width/3,b.me.y],g=[b.me.x+b.me.width*2/3,b.me.y+b.me.height*2/3],e=[Math.max(e[0],f[0]),Math.max(e[1],f[1])];d=[Math.min(d[0],g[0]),Math.min(d[1],g[1])];d=e[0]<
d[0]&&e[1]<d[1]?true:false;d&&b.me.die();c.y=c.y+c.speed}}};b.plainsDies=[];b.plainsDying=function(){for(var a=b.plainsDies.length;a--;){var c=b.plainsDies[a];c.animationTime==0?b.plainsDies.splice(a,1):c.call()}};b.over=function(){$(d).removeClass("playing");s?d.removeEventListener("touchmove"):$(d).off("mousemove");d.onclick=function(){};clearInterval(b.clock);l.show(b.score)};b.clear=function(){b.me.x=(i-b.me.width)/2;b.me.y=h-b.me.height;b.plains=[];b.plainsDies=[];b.plainsNum=0;b.time=0;b.bgScrollTime=
0;b.score=0;b.me.status=true;b.me.bomb=0;b.me.attackPower=false;clearTimeout(b.me.attackPowerClock)};b.start=function(){$(d).addClass("playing");d.onclick=b.useBomb;if(s)d.addEventListener("touchmove",function(a){a.preventDefault();var c=a.targetTouches[0],a=c.pageX-$(d).offset().left,c=c.pageY-$(d).offset().top;b.me.move(a,c)});else $(d).on("mousemove",function(a){var a=a?a:window.event,c=a.clientX-$(d).offset().left,a=a.clientY-$(d).offset().top;b.me.move(c,a)});l.hide();b.clear();b.clock=setInterval(function(){b.refresh()},
b.refreshInterval)};b.refreshMessage=function(){g.fillText(b.score,20,44);if(b.me.bomb>0){var a=f("bomb.png");g.drawImage(a,10,h-a.height-10,a.width,a.height);g.fillText(b.me.bomb,20+a.width,h-a.height+28)}};b.start();document.getElementById("modal").getElementsByTagName("button")[0].onclick=b.start;clearInterval(k)})})}})();